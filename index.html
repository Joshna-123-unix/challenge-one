<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smart Habit Tracker â€” Vanilla HTML</title>
  <style>
    :root{--bg:#ffffff;--fg:#111827;--muted:#6b7280;--border:#e5e7eb;--accent:#111827;--soft:#f3f4f6}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji";background:var(--bg);color:var(--fg)}
    .container{max-width:960px;margin:0 auto;padding:24px}
    h1{font-size:28px;margin:0 0 4px} .sub{color:var(--muted);font-size:13px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:16px;border:1px solid var(--border);background:#fff;color:var(--fg);cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .card{border:1px solid var(--border);border-radius:24px;padding:16px;background:#fff}
    label{font-size:12px;color:var(--muted)} input[type=text]{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:14px}
    input[type=range]{width:100%}
    .grid3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    .metric{border:1px solid var(--border);border-radius:16px;padding:12px}
    .metric .h{font-size:12px;color:var(--muted)} .metric .v{font-weight:700;font-size:22px}
    .health{height:10px;background:var(--soft);border-radius:999px;overflow:hidden;margin-top:6px}
    .health > div{height:100%;background:var(--accent)}
    .header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin-bottom:24px}
    .muted{color:var(--muted)} .nums{font-variant-numeric:tabular-nums}
    .flex{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .space{height:8px}
    .heat{display:flex;gap:4px;flex-wrap:wrap}
    .dot{width:12px;height:12px;border-radius:3px;background:var(--soft);border:1px solid var(--border)}
    .dot.done{background:var(--accent);border-color:var(--accent)}
    details{border-top:1px solid var(--border);padding-top:12px;margin-top:12px}
    .empty{border:1px dashed var(--border);border-radius:24px;padding:24px;text-align:center;color:var(--muted)}
    @media (max-width:720px){.grid3{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1>Smart Habit Tracker</h1>
        <div class="sub">Streaks that bend, not break âœ¨</div>
      </div>
      <button id="resetAll" class="btn" title="Reset all data">âŸ² Reset</button>
    </div>

    <div class="card" id="newHabitCard">
      <div class="row" style="align-items:flex-end">
        <div style="flex:1 1 300px">
          <label>Habit name</label>
          <input type="text" id="habitName" placeholder="e.g., Read 10 pages" />
        </div>
        <div style="flex:1 1 260px">
          <label>Decay (per missed day)</label>
          <div class="row" style="align-items:center">
            <input type="range" id="decayInput" min="0.6" max="0.99" step="0.01" value="0.9" />
            <span class="nums" id="decayLabel" style="width:56px;text-align:right">0.90Ã—</span>
          </div>
        </div>
        <div>
          <button class="btn primary" id="addHabit">ï¼‹ Add Habit</button>
        </div>
      </div>
    </div>

    <div id="habitList" style="margin-top:16px"></div>

    <template id="habitTpl">
      <div class="card habit">
        <div class="row" style="justify-content:space-between;align-items:flex-start">
          <div>
            <div class="title" style="font-size:18px;font-weight:600"></div>
            <div class="muted">Decay: <span class="nums decayVal"></span>Ã—/day</div>
          </div>
          <div class="row">
            <button class="btn toggleDetails">âš™ï¸Ž Details</button>
            <button class="btn deleteBtn" style="color:#b91c1c;border-color:#fecaca">ðŸ—‘ Delete</button>
          </div>
        </div>

        <div class="grid3" style="margin-top:12px">
          <div class="metric"><div class="h">Streak</div><div class="v nums streakDays">0 days</div></div>
          <div class="metric"><div class="h">Momentum</div><div class="v nums momentum">0.00</div></div>
          <div class="metric">
            <div class="h">Health</div>
            <div class="health"><div class="bar" style="width:0%"></div></div>
            <div class="nums muted" style="font-size:12px;margin-top:4px"><span class="healthPct">0</span>%</div>
          </div>
        </div>

        <div class="flex" style="margin-top:12px">
          <button class="btn primary completeBtn">âœ” Complete today</button>
          <div class="muted flex">ðŸ“ˆ Last done: <span class="lastDone">â€”</span></div>
        </div>

        <details class="details">
          <summary class="muted">Open details</summary>
          <div class="row" style="margin-top:12px">
            <div style="flex:1 1 260px">
              <label>Adjust decay</label>
              <div class="row" style="align-items:center">
                <input type="range" class="decayRange" min="0.6" max="0.99" step="0.01" />
                <span class="nums decayOut" style="width:56px;text-align:right"></span>
              </div>
            </div>
            <div style="flex:2 1 360px">
              <div class="muted" style="margin-bottom:4px">Last 30 days</div>
              <div class="heat"></div>
            </div>
          </div>
        </details>
      </div>
    </template>
  </div>

  <script>
    // ----------------------------- Helpers
    const STORAGE_KEY = 'smart-habit-tracker-v1';

    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    const startOfDayISO = (d=new Date()) => {
      const x = new Date(d); x.setHours(0,0,0,0); return x.toISOString();
    };
    const fmtDate = (iso) => {
      if (!iso) return 'â€”';
      const d = new Date(iso); return d.toLocaleDateString(undefined, { month:'short', day:'numeric', year:'numeric' });
    };
    const daysBetween = (aISO, bISO) => {
      const a = new Date(aISO); const b = new Date(bISO);
      const ms = (b - a); return Math.max(0, Math.floor(ms / 86400000));
    };

    const load = () => { try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [] }catch{ return [] } };
    const save = (data) => localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);

    const applyPendingDecay = (habit, todayISO) => {
      const missed = daysBetween(habit.lastTouched, todayISO);
      if (missed <= 0) return habit;
      const decayed = Math.max(0, habit.streakPoints * Math.pow(habit.decay, missed));
      return {
        ...habit,
        streakPoints: decayed,
        lastTouched: todayISO,
        history: [...habit.history, { date: todayISO, action: 'auto-decay', points: decayed }]
      };
    };

    const completeToday = (habit, todayISO) => {
      let h = applyPendingDecay(habit, todayISO);
      const last = h.lastCompleted ? new Date(h.lastCompleted) : null;
      const today = new Date(todayISO);
      if (last && last.getTime() === today.getTime()) return h; // already completed today
      const newPoints = h.streakPoints + 1;
      h = {
        ...h,
        streakPoints: newPoints,
        lastCompleted: todayISO,
        lastTouched: todayISO,
        history: [...h.history, { date: todayISO, action: 'complete', points: newPoints }]
      };
      return h;
    };

    const streakInt = (p) => Math.floor(p + 1e-9);
    const healthPercent = (p) => Math.max(0, Math.min(100, 100 * (1 - Math.exp(-p/3))));

    const last30Days = () => {
      const arr = []; const today = new Date(); today.setHours(0,0,0,0);
      for (let i=29;i>=0;i--){ const d = new Date(today); d.setDate(today.getDate()-i); arr.push(d); }
      return arr;
    };

    // ----------------------------- State & Rendering
    let state = load();

    const render = () => {
      save(state);
      const list = document.getElementById('habitList');
      list.innerHTML = '';
      if (state.length === 0){
        const div = document.createElement('div');
        div.className = 'empty';
        div.innerHTML = '<div>No habits yet.</div><div style="font-size:13px;margin-top:6px">Add your first habit above and start building momentum!</div>';
        list.appendChild(div); return;
      }
      const tpl = document.getElementById('habitTpl');
      const todayISO = startOfDayISO();

      state.forEach((habit) => {
        // Ensure pending decay applied when rendering
        let h = applyPendingDecay(habit, todayISO);
        if (h !== habit){
          Object.assign(habit, h); // mutate in place so indexes stable
        }
        const node = tpl.content.firstElementChild.cloneNode(true);
        $('.title', node).textContent = habit.name;
        $('.decayVal', node).textContent = habit.decay.toFixed(2);

        const alreadyDone = habit.lastCompleted && (new Date(habit.lastCompleted).getTime() === new Date(todayISO).getTime());
        $('.completeBtn', node).disabled = !!alreadyDone;
        $('.completeBtn', node).textContent = alreadyDone ? 'âœ” Completed today' : 'âœ” Complete today';

        $('.streakDays', node).textContent = `${streakInt(habit.streakPoints)} days`;
        $('.momentum', node).textContent = habit.streakPoints.toFixed(2);
        const hp = Math.round(healthPercent(habit.streakPoints));
        $('.bar', node).style.width = hp + '%';
        $('.healthPct', node).textContent = hp;
        $('.lastDone', node).textContent = fmtDate(habit.lastCompleted);

        // actions
        $('.deleteBtn', node).addEventListener('click', () => {
          if (!confirm('Delete this habit?')) return;
          state = state.filter(x => x.id !== habit.id); render();
        });
        $('.completeBtn', node).addEventListener('click', () => {
          const updated = completeToday(habit, todayISO);
          Object.assign(habit, updated); render();
        });

        // details
        const decR = $('.decayRange', node);
        const decOut = $('.decayOut', node);
        decR.value = habit.decay;
        decOut.textContent = habit.decay.toFixed(2) + 'Ã—';
        decR.addEventListener('input', (e) => {
          habit.decay = parseFloat(e.target.value);
          $('.decayVal', node).textContent = habit.decay.toFixed(2);
          decOut.textContent = habit.decay.toFixed(2) + 'Ã—';
          render();
        });

        // heatmap
        const heat = $('.heat', node);
        const completedSet = new Set(
          habit.history.filter(hh => hh.action === 'complete')
            .map(hh => startOfDayISO(new Date(hh.date)))
        );
        if (habit.lastCompleted) completedSet.add(startOfDayISO(new Date(habit.lastCompleted)));
        last30Days().forEach(d => {
          const iso = startOfDayISO(d);
          const dot = document.createElement('div');
          dot.className = 'dot' + (completedSet.has(iso) ? ' done' : '');
          dot.title = `${d.toLocaleDateString(undefined,{month:'short',day:'numeric'})}: ${completedSet.has(iso) ? 'done' : 'missed'}`;
          heat.appendChild(dot);
        });

        // toggle details label keeps native <summary>
        $('.toggleDetails', node).addEventListener('click', () => {
          const details = $('.details', node);
          details.open = !details.open;
        });

        document.getElementById('habitList').appendChild(node);
      });
    };

    // ----------------------------- Init UI
    const nameInput = document.getElementById('habitName');
    const decayInput = document.getElementById('decayInput');
    const decayLabel = document.getElementById('decayLabel');
    decayInput.addEventListener('input', () => { decayLabel.textContent = parseFloat(decayInput.value).toFixed(2) + 'Ã—'; });

    document.getElementById('addHabit').addEventListener('click', () => {
      const name = nameInput.value.trim();
      if (!name) return;
      const todayISO = startOfDayISO();
      state.unshift({
        id: uid(),
        name,
        createdAt: todayISO,
        lastTouched: todayISO,
        lastCompleted: null,
        streakPoints: 0,
        decay: parseFloat(decayInput.value),
        history: []
      });
      nameInput.value = '';
      render();
    });

    document.getElementById('resetAll').addEventListener('click', () => {
      if (!confirm('Reset all habits? This cannot be undone.')) return;
      state = []; render();
    });

    // First render
    render();
  </script>
</body>
</html>
